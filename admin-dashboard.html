<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Axxess Dealer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        :root {
            --sidebar-width: 240px;
            --sidebar-bg: #ffffff;
            --sidebar-border: #e8ecf0;
            --sidebar-text: #3d4f5f;
            --sidebar-text-muted: #8a9bae;
            --sidebar-hover: #f4f6f8;
            --sidebar-active-bg: #eef2ff;
            --sidebar-active-text: #4f46e5;
            --sidebar-section-label: #8a9bae;
            --topbar-bg: #ffffff;
            --topbar-border: #e8ecf0;
            --main-bg: #f4f6f8;
            --card-bg: #ffffff;
            --card-border: #e8ecf0;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.04);
            --card-hover-shadow: 0 4px 12px rgba(0,0,0,0.06);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --primary: #4f46e5;
            --primary-light: #eef2ff;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            --orange: #f97316;
            --orange-light: #fff7ed;
            --purple: #8b5cf6;
            --purple-light: #f5f3ff;
            --cyan: #06b6d4;
            --cyan-light: #ecfeff;
            --pink: #ec4899;
            --pink-light: #fdf2f8;
        }
        .sidebar-bg { background: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border); }
        .main-bg { background: var(--main-bg); }
        .card { 
            background: var(--card-bg); 
            border-radius: 0.5rem; 
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: box-shadow 0.2s ease;
        }
        .card:hover { box-shadow: var(--card-hover-shadow); }
        .btn-primary { 
            background: var(--primary);
            color: white;
            transition: all 0.2s ease;
        }
        .btn-primary:hover { 
            background: #4338ca;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #059669; }

        /* Status badges */
        .status-new { background: var(--info-light); color: #1e40af; }
        .status-lead { background: var(--warning-light); color: #92400e; }
        .status-pending { background: var(--warning-light); color: #92400e; }
        .status-contacted { background: var(--purple-light); color: #5b21b6; }
        .status-qualified { background: var(--success-light); color: #065f46; }
        .status-processing { background: var(--info-light); color: #1e40af; }
        .status-scheduled { background: var(--purple-light); color: #5b21b6; }
        .status-completed { background: var(--success-light); color: #065f46; }
        .status-converted { background: #bbf7d0; color: #166534; }
        .status-cancelled { background: var(--danger-light); color: #991b1b; }
        .status-returned { background: var(--pink-light); color: #9d174d; }
        .status-lost { background: #f3f4f6; color: #4b5563; }

        /* Splynx-style stat cards */
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: box-shadow 0.2s ease;
        }
        .stat-card:hover { box-shadow: var(--card-hover-shadow); }
        .stat-card .stat-icon {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .stat-card .stat-icon svg { width: 20px; height: 20px; }
        .stat-card .stat-body { flex: 1; }
        .stat-card .stat-label { font-size: 0.8125rem; font-weight: 500; color: var(--text-primary); }
        .stat-card .stat-link { font-size: 0.75rem; color: var(--primary); cursor: pointer; }
        .stat-card .stat-link:hover { text-decoration: underline; }
        .stat-card .stat-value { font-size: 1.75rem; font-weight: 700; line-height: 1.2; }

        /* Sidebar navigation */
        .nav-section-label {
            font-size: 0.6875rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--sidebar-section-label);
            padding: 1.25rem 1.25rem 0.5rem; margin-top: 0.25rem;
        }
        .nav-item { 
            display: flex; align-items: center; gap: 0.625rem;
            padding: 0.5rem 1.25rem; margin: 1px 0.5rem;
            border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 400;
            color: var(--sidebar-text); transition: all 0.15s ease;
            text-decoration: none; cursor: pointer;
        }
        .nav-item:hover { background: var(--sidebar-hover); color: var(--text-primary); }
        .nav-item.active { 
            background: var(--sidebar-active-bg); 
            color: var(--sidebar-active-text); 
            font-weight: 500;
        }
        .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }

        /* Modern Select */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
            padding-right: 2rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.15s ease;
        }
        select:hover { border-color: var(--primary); }
        select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }

        .table-row:hover { background: #f8fafc; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-container { background: white; border-radius: 0.75rem; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); overflow: hidden; }
        .modal-container .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--card-border); }
        .modal-container .modal-header button { font-size: 1.5rem; line-height: 1; }

        /* Axxess sub-tabs */
        .ax-tab-btn { color: #6b7280; background: transparent; }
        .ax-tab-btn:hover { background: rgba(0,0,0,0.05); }
        .ax-tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Shortcuts bar */
        .shortcut-link {
            display: inline-flex; align-items: center; gap: 0.375rem;
            font-size: 0.8125rem; color: var(--primary); padding: 0.25rem 0;
            cursor: pointer; transition: color 0.15s;
        }
        .shortcut-link:hover { color: #4338ca; text-decoration: underline; }
        .shortcut-link svg { width: 16px; height: 16px; }

        /* Collapsible panel */
        .panel-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.875rem 1rem; cursor: pointer; user-select: none;
        }
        .panel-title { font-size: 0.9375rem; font-weight: 600; color: var(--text-primary); }

        /* Finance summary rows */
        .finance-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.375rem 0; font-size: 0.8125rem;
        }
        .finance-row .label { color: var(--text-secondary); }
        .finance-row .value { font-weight: 500; color: var(--text-primary); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-left: 0 !important; }
            .mobile-header { display: flex !important; }
            .desktop-search { display: none !important; }
        }
        @media (min-width: 769px) {
            .mobile-header { display: none !important; }
            .sidebar-overlay { display: none !important; }
        }
        @media (max-width: 1024px) {
            .card { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr; }
            .card h3 { font-size: 1.5rem; }
            .modal > div { margin: 0.5rem; max-height: 95vh; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.5rem 0.25rem; }
        }
        @media (min-width: 1536px) { .main-content { max-width: none; } }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @media (hover: none) {
            .btn-primary:hover { transform: none; }
            .nav-item { padding: 0.625rem 1.25rem; }
        }
        .accent-border { border-left: 4px solid var(--primary); }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar sidebar-bg fixed left-0 top-0 z-50 flex flex-col min-h-screen" style="width: var(--sidebar-width)" id="sidebar">
        <!-- Logo -->
        <div class="px-5 py-4 border-b" style="border-color: var(--sidebar-border)">
            <div class="flex items-center gap-2.5">
                <img src="https://i.ibb.co/fGy3TCJd/logo-axxess-1.png" alt="Axxess" class="h-8" style="filter: brightness(0) saturate(100%)">
                <div>
                    <h1 class="font-semibold text-sm" style="color: var(--text-primary)">Axxess Africa</h1>
                    <p class="text-xs" style="color: var(--text-muted)">Dealer Portal</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-2">
            <!-- MAIN -->
            <div class="nav-section-label">Main</div>
            <a href="#dashboard" class="nav-item active" onclick="showSection('dashboard')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                Dashboard
            </a>

            <!-- CRM -->
            <div class="nav-section-label">CRM</div>
            <a href="#leads" class="nav-item" onclick="showSection('leads')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Leads
            </a>
            <a href="#preorders" class="nav-item" onclick="showSection('preorders')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Preorders
                <span id="preordersBadge" class="hidden bg-purple-500 text-white text-xs px-1.5 py-0.5 rounded-full ml-auto" style="font-size:10px">0</span>
            </a>
            <a href="#orders" class="nav-item" onclick="showSection('orders')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Orders
            </a>

            <!-- FINANCE -->
            <div class="nav-section-label">Finance</div>
            <a href="#payments" class="nav-item" onclick="showSection('payments')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Payments
                <span id="paymentsBadge" class="hidden bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full ml-auto" style="font-size:10px">0</span>
            </a>
            <a href="#axxess-sales" class="nav-item" onclick="showSection('axxess-sales')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                Axxess Sales
            </a>

            <!-- OPERATIONS -->
            <div class="nav-section-label">Operations</div>
            <a href="#shipping" class="nav-item" onclick="showSection('shipping')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                Shipping
                <span id="shippingBadge" class="hidden bg-orange-500 text-white text-xs px-1.5 py-0.5 rounded-full ml-auto" style="font-size:10px">0</span>
            </a>
            <a href="#returned" class="nav-item" onclick="showSection('returned')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                Returned Items
                <span id="returnedItemsBadge" class="hidden bg-pink-500 text-white text-xs px-1.5 py-0.5 rounded-full ml-auto" style="font-size:10px">0</span>
            </a>
            <a href="#packages" class="nav-item" onclick="showSection('packages')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Packages
            </a>

            <!-- COMPANY -->
            <div class="nav-section-label">Company</div>
            <a href="#agents" class="nav-item" onclick="showSection('agents')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                Agents
            </a>
            <a href="#pending-agents" class="nav-item" onclick="showSection('pending-agents')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                Pending Agents
                <span id="pendingAgentsBadge" class="hidden bg-orange-500 text-white text-xs px-1.5 py-0.5 rounded-full ml-auto" style="font-size:10px">0</span>
            </a>
            <a href="#dealers" class="nav-item" onclick="showSection('dealers')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                Dealers
            </a>

            <!-- SYSTEM -->
            <div class="nav-section-label">System</div>
            <a href="#reports" class="nav-item" onclick="showSection('reports')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                Reports
            </a>
            <a href="#import" class="nav-item" onclick="showSection('import')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                Import Leads
            </a>
            <a href="#settings" class="nav-item" onclick="showSection('settings')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Settings
            </a>
        </nav>

        <!-- User Section -->
        <div class="px-4 py-3 border-t" style="border-color: var(--sidebar-border)">
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-semibold text-xs" style="background: var(--primary)">
                    <span id="userInitials">A</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate" style="color: var(--text-primary)" id="userName">Admin</p>
                    <p class="text-xs" style="color: var(--text-muted)">Administrator</p>
                </div>
                <button onclick="logout()" class="p-1.5 rounded-md hover:bg-gray-100 transition" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" style="color: var(--text-muted)" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content main-bg flex-1 min-h-screen" style="margin-left: var(--sidebar-width)">
        <!-- Header -->
        <header class="bg-white border-b px-4 md:px-6 py-3 flex items-center justify-between sticky top-0 z-40" style="border-color: var(--topbar-border)">
            <!-- Mobile menu button -->
            <button class="mobile-header p-2 -ml-2 text-gray-700 hover:bg-gray-100 rounded-lg" onclick="toggleSidebar()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <!-- Breadcrumb + Title -->
            <div class="flex-1 md:flex-none">
                <div class="flex items-center gap-1.5 text-xs" style="color: var(--text-muted)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span>Home</span>
                    <span>/</span>
                    <span id="pageSubtitle" style="color: var(--text-secondary)">Dashboard</span>
                </div>
                <h2 class="text-base md:text-lg font-semibold mt-0.5" style="color: var(--text-primary)" id="pageTitle">Dashboard</h2>
            </div>
            <!-- Right side: search, notifications -->
            <div class="flex items-center gap-2 md:gap-3">
                <div class="relative desktop-search">
                    <input type="text" id="globalSearch" placeholder="Search leads, orders..." class="pl-9 pr-4 py-1.5 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-400 w-56" style="border-color: var(--card-border)" oninput="globalSearchHandler(this.value)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--text-muted)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <button onclick="toggleNotifications()" class="relative p-2 rounded-lg hover:bg-gray-100 transition" id="notificationBtn" style="color: var(--text-secondary)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span id="notificationBadge" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
                <!-- Notifications Dropdown -->
                <div id="notificationsDropdown" class="hidden absolute right-4 top-14 w-80 bg-white rounded-lg shadow-lg border z-50" style="border-color: var(--card-border)">
                    <div class="px-4 py-3 border-b" style="border-color: var(--card-border)">
                        <h4 class="font-semibold text-sm" style="color: var(--text-primary)">Notifications</h4>
                    </div>
                    <div id="notificationsList" class="max-h-80 overflow-y-auto">
                        <p class="p-4 text-sm text-center" style="color: var(--text-muted)">No new notifications</p>
                    </div>
                </div>
                <span class="text-xs hidden md:inline" style="color: var(--text-muted)" id="dashboardTimestamp"></span>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="section-dashboard" class="p-4 md:p-6">
            <!-- Stat Cards Row 1: Main KPIs -->
            <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3 mb-5">
                <div class="stat-card cursor-pointer" onclick="showSection('leads')">
                    <div class="stat-icon" style="background: var(--info-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--info)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value" style="color: var(--info)" id="totalLeads">0</div>
                    </div>
                    <span class="stat-link" onclick="showSection('leads')">View</span>
                </div>
                <div class="stat-card cursor-pointer" onclick="showSection('orders')">
                    <div class="stat-icon" style="background: var(--success-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--success)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" style="color: var(--success)" id="totalOrders">0</div>
                    </div>
                    <span class="stat-link" onclick="showSection('orders')">View</span>
                </div>
                <div class="stat-card cursor-pointer" onclick="showSection('agents')">
                    <div class="stat-icon" style="background: var(--purple-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--purple)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Active Agents</div>
                        <div class="stat-value" style="color: var(--purple)" id="totalAgents">0</div>
                    </div>
                    <span class="stat-link" onclick="showSection('agents')">View</span>
                </div>
                <div class="stat-card cursor-pointer" onclick="showSection('dealers')">
                    <div class="stat-icon" style="background: var(--orange-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--orange)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Dealers</div>
                        <div class="stat-value" style="color: var(--orange)" id="totalDealers">0</div>
                    </div>
                    <span class="stat-link" onclick="showSection('dealers')">View</span>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--pink-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--pink)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Conversion Rate</div>
                        <div class="stat-value" style="color: var(--pink)" id="conversionRate">0%</div>
                    </div>
                    <span class="text-xs" style="color:var(--text-muted)" id="dashTimestampSmall"></span>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--cyan-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--cyan)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Total Commission</div>
                        <div class="stat-value" style="color: var(--cyan)" id="totalCommission">R0</div>
                    </div>
                    <span class="text-xs" style="color:var(--text-muted)" id="dashTimestampSmall2"></span>
                </div>
            </div>

            <!-- Shortcuts Bar -->
            <div class="card px-4 py-3 mb-5 flex flex-wrap items-center gap-4">
                <span class="text-xs font-semibold uppercase" style="color: var(--text-muted)">Quick Actions</span>
                <span class="shortcut-link" onclick="openModal('addLeadModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Lead
                </span>
                <span class="shortcut-link" onclick="openModal('openserveEmailModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Import Email
                </span>
                <span class="shortcut-link" onclick="showSection('orders')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    View Orders
                </span>
                <span class="shortcut-link" onclick="showSection('payments')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    Payments
                </span>
                <span class="shortcut-link" onclick="showSection('reports')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    Reports
                </span>
            </div>

            <!-- Revenue & Commission Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--success)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Confirmed Revenue</div>
                        <div class="stat-value text-xl" style="color: var(--success)" id="confirmedRevenue">R0</div>
                        <div class="text-xs" style="color:var(--text-muted)"><span id="confirmedCount">0</span> confirmed</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--warning)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Pending Revenue</div>
                        <div class="stat-value text-xl" style="color: var(--warning)" id="pendingRevenue">R0</div>
                        <div class="text-xs" style="color:var(--text-muted)"><span id="pendingCount">0</span> pending</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--danger-light)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="var(--danger)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <div class="stat-body">
                        <div class="stat-label">Rejected / Lost</div>
                        <div class="stat-value text-xl" style="color: var(--danger)" id="rejectedRevenue">R0</div>
                        <div class="text-xs" style="color:var(--text-muted)"><span id="rejectedCount">0</span> rejected</div>
                    </div>
                </div>
            </div>

            <!-- Order Status + Lead Pipeline in 2 columns -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">
                <!-- Order Status -->
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Order Status</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('orders'); setTimeout(()=>{document.getElementById('orderStatusFilter').value='pending'; filterOrders();}, 100)">
                            <p class="text-2xl font-bold" style="color: var(--warning)" id="dashPendingOrders">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Pending</p>
                        </div>
                        <div class="p-3 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('orders'); setTimeout(()=>{document.getElementById('orderStatusFilter').value='processing'; filterOrders();}, 100)">
                            <p class="text-2xl font-bold" style="color: var(--info)" id="dashProcessingOrders">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Processing</p>
                        </div>
                        <div class="p-3 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('orders'); setTimeout(()=>{document.getElementById('orderStatusFilter').value='completed'; filterOrders();}, 100)">
                            <p class="text-2xl font-bold" style="color: var(--success)" id="dashCompletedOrders">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Completed</p>
                        </div>
                        <div class="p-3 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('orders'); setTimeout(()=>{document.getElementById('orderStatusFilter').value='cancelled'; filterOrders();}, 100)">
                            <p class="text-2xl font-bold" style="color: var(--danger)" id="dashCancelledOrders">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Cancelled</p>
                        </div>
                    </div>
                </div>

                <!-- Lead Pipeline -->
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Lead Pipeline</h3>
                    <div class="grid grid-cols-5 gap-2">
                        <div class="p-2 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('leads'); setTimeout(()=>{document.getElementById('leadStatusFilter').value='new'; filterLeads();}, 100)">
                            <p class="text-xl font-bold" style="color: var(--info)" id="dashNewLeads">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">New</p>
                        </div>
                        <div class="p-2 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('leads'); setTimeout(()=>{document.getElementById('leadStatusFilter').value='contacted'; filterLeads();}, 100)">
                            <p class="text-xl font-bold" style="color: var(--purple)" id="dashContactedLeads">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Contacted</p>
                        </div>
                        <div class="p-2 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('leads'); setTimeout(()=>{document.getElementById('leadStatusFilter').value='qualified'; filterLeads();}, 100)">
                            <p class="text-xl font-bold" style="color: var(--success)" id="dashQualifiedLeads">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Qualified</p>
                        </div>
                        <div class="p-2 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('leads'); setTimeout(()=>{document.getElementById('leadStatusFilter').value='converted'; filterLeads();}, 100)">
                            <p class="text-xl font-bold text-green-600" id="dashConvertedLeads">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Converted</p>
                        </div>
                        <div class="p-2 rounded-md cursor-pointer hover:bg-gray-50 transition text-center" onclick="showSection('leads'); setTimeout(()=>{document.getElementById('leadStatusFilter').value='lost'; filterLeads();}, 100)">
                            <p class="text-xl font-bold text-gray-500" id="dashLostLeads">0</p>
                            <p class="text-xs" style="color: var(--text-muted)">Lost</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Section - Lead Status, Top Agents, Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-5">
                <!-- Lead Status Breakdown -->
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Lead Status Breakdown</h3>
                    <div class="space-y-3" id="leadStatusBreakdown">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Top Performing Agents -->
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Top Performing Agents</h3>
                    <div class="space-y-3" id="topAgents">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Recent Activity</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto" id="recentActivity">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Orders Overview</h3>
                    <canvas id="ordersChart" height="200"></canvas>
                </div>
                <div class="card p-4">
                    <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Lead Sources</h3>
                    <canvas id="leadsChart" height="200"></canvas>
                </div>
            </div>

            <!-- Recent Orders Table -->
            <div class="card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-semibold uppercase" style="color: var(--text-muted)">Recent Orders</h3>
                    <a href="#orders" onclick="showSection('orders')" class="text-xs font-medium" style="color: var(--primary)">View All &rarr;</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-500 text-xs border-b">
                                <th class="pb-2 font-medium">Client</th>
                                <th class="pb-2 font-medium">Package</th>
                                <th class="pb-2 font-medium">Agent</th>
                                <th class="pb-2 font-medium">Status</th>
                                <th class="pb-2 font-medium">Date</th>
                                <th class="pb-2 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                            <tr class="table-row border-b">
                                <td class="py-2" colspan="6">
                                    <p class="text-gray-500 text-center">Loading...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Leads Section -->
        <section id="section-leads" class="p-4 md:p-6 hidden">
            <!-- Section Header -->
            <div class="flex items-center justify-between mb-5">
                <div>
                    <p class="text-sm" style="color: var(--text-muted)" id="leadsSubtitle">Manage and track all incoming leads</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openModal('openserveEmailModal')" class="border px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-50 transition flex items-center gap-1.5" style="border-color: var(--card-border); color: var(--text-secondary)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        Import Email
                    </button>
                    <button onclick="openModal('addLeadModal')" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Lead
                    </button>
                </div>
            </div>

            <!-- Lead Pipeline Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-6 gap-3 mb-5">
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('leadStatusFilter').value=''; filterLeads();">
                    <p class="text-xs text-gray-400 font-medium mb-1">All Leads</p>
                    <p class="text-3xl font-bold text-gray-700" id="leadsAllCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('leadStatusFilter').value='new'; filterLeads();">
                    <p class="text-xs text-gray-400 font-medium mb-1">New</p>
                    <p class="text-3xl font-bold text-blue-500" id="leadsNewCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('leadStatusFilter').value='contacted'; filterLeads();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Contacted</p>
                    <p class="text-3xl font-bold text-indigo-500" id="leadsContactedCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('leadStatusFilter').value='qualified'; filterLeads();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Qualified</p>
                    <p class="text-3xl font-bold text-emerald-500" id="leadsQualifiedCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('leadStatusFilter').value='converted'; filterLeads();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Converted</p>
                    <p class="text-3xl font-bold text-green-600" id="leadsConvertedCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('leadStatusFilter').value='lost'; filterLeads();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Lost</p>
                    <p class="text-3xl font-bold text-gray-500" id="leadsLostCount">0</p>
                </div>
            </div>

            <!-- Filters & Search -->
            <div class="flex flex-wrap items-center gap-3 mb-6">
                <div class="relative flex-1 min-w-[200px] max-w-sm">
                    <input type="text" id="leadSearchFilter" placeholder="Search name, email, phone, lead ID..." 
                        class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20"
                        oninput="filterLeads()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <select id="leadStatusFilter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" onchange="filterLeads()">
                    <option value="">All Status</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="qualified">Qualified</option>
                    <option value="converted">Converted</option>
                    <option value="lost">Lost</option>
                </select>
                <select id="leadAgentFilter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" onchange="filterLeads()">
                    <option value="">All Agents</option>
                </select>
                <select id="leadDealerFilter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" onchange="filterLeads()">
                    <option value="">All Dealers</option>
                </select>
                <button onclick="clearLeadFilters()" class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm border rounded-lg hover:bg-gray-50">Clear</button>
                <span id="leadFilterCount" class="text-sm text-gray-500 ml-auto"></span>
            </div>

            <!-- Bulk Assign Bar -->
            <div id="bulkAssignBar" class="hidden bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-4 flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                    <span class="text-sm font-semibold text-indigo-700" id="bulkSelectedCount">0 selected</span>
                </div>
                <select id="bulkAssignAgent" class="border border-indigo-200 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    <option value="">Select Internal Agent</option>
                </select>
                <button onclick="bulkAssignLeads()" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Assign Selected
                </button>
                <button onclick="clearBulkSelection()" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50">Clear Selection</button>
            </div>

            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-500 text-xs uppercase tracking-wider">
                                <th class="py-3 px-4 font-medium w-8"><input type="checkbox" id="selectAllLeads" onchange="toggleSelectAllLeads(this)" class="rounded"></th>
                                <th class="py-3 px-4 font-medium">Client Name</th>
                                <th class="py-3 px-4 font-medium">Contact</th>
                                <th class="py-3 px-4 font-medium">Address</th>
                                <th class="py-3 px-4 font-medium">Package Interest</th>
                                <th class="py-3 px-4 font-medium">Agent</th>
                                <th class="py-3 px-4 font-medium">Dealer</th>
                                <th class="py-3 px-4 font-medium">Status</th>
                                <th class="py-3 px-4 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTable">
                            <tr class="table-row border-b">
                                <td class="py-4 px-4" colspan="8">
                                    <p class="text-gray-500 text-center">Loading leads...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Orders Section -->
        <section id="section-orders" class="p-4 md:p-6 hidden">
            <!-- Section Header -->
            <div class="flex items-center justify-between mb-5">
                <p class="text-sm" style="color: var(--text-muted)">Track and manage all customer orders</p>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('orderStatusFilter').value=''; filterOrders();">
                    <p class="text-xs text-gray-400 font-medium mb-1">All Orders</p>
                    <p class="text-3xl font-bold text-gray-700" id="ordersAllCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('orderStatusFilter').value='pending'; filterOrders();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Pending</p>
                    <p class="text-3xl font-bold text-amber-500" id="ordersPendingCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('orderStatusFilter').value='processing'; filterOrders();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Processing</p>
                    <p class="text-3xl font-bold text-blue-500" id="ordersProcessingCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('orderStatusFilter').value='completed'; filterOrders();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Completed</p>
                    <p class="text-3xl font-bold text-emerald-500" id="ordersCompletedCount">0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="document.getElementById('orderStatusFilter').value='cancelled'; filterOrders();">
                    <p class="text-xs text-gray-400 font-medium mb-1">Cancelled</p>
                    <p class="text-3xl font-bold text-red-500" id="ordersCancelledCount">0</p>
                </div>
            </div>

            <!-- Filters & Search -->
            <div class="flex flex-wrap items-center gap-3 mb-6">
                <div class="relative flex-1 min-w-[200px] max-w-sm">
                    <input type="text" id="orderSearchFilter" placeholder="Search orders..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20" oninput="filterOrders()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <select id="orderStatusFilter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" onchange="filterOrders()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <select id="orderAgentFilter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" onchange="filterOrders()">
                    <option value="">All Agents</option>
                </select>
                <span id="orderFilterCount" class="text-sm text-gray-500 ml-auto"></span>
            </div>

            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-500 text-xs uppercase tracking-wider">
                                <th class="py-3 px-4 font-medium">Order ID</th>
                                <th class="py-3 px-4 font-medium">Client</th>
                                <th class="py-3 px-4 font-medium">Package</th>
                                <th class="py-3 px-4 font-medium">Agent</th>
                                <th class="py-3 px-4 font-medium">Status</th>
                                <th class="py-3 px-4 font-medium">Created</th>
                                <th class="py-3 px-4 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr class="table-row border-b">
                                <td class="py-4 px-4" colspan="7">
                                    <p class="text-gray-500 text-center">Loading orders...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payments Section -->
        <section id="section-payments" class="p-4 md:p-6 hidden">
            <!-- Section Header -->
            <div class="flex items-center justify-between mb-5">
                <p class="text-sm" style="color: var(--text-muted)">Monitor client payments, flag overdue accounts, send reminders</p>
                <button onclick="exportPaymentReport()" class="border px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-50 transition flex items-center gap-1.5" style="border-color: var(--card-border); color: var(--text-secondary)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Export Report
                </button>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="filterPayments('')">
                    <p class="text-xs text-gray-400 font-medium mb-1">Total Orders</p>
                    <p class="text-3xl font-bold text-gray-700" id="payTotalOrders">0</p>
                    <p class="text-xs text-gray-400 mt-1" id="payTotalAmount">R0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all border-l-4 border-l-emerald-500" onclick="filterPayments('paid')">
                    <p class="text-xs text-gray-400 font-medium mb-1">Paid</p>
                    <p class="text-3xl font-bold text-emerald-600" id="payPaidCount">0</p>
                    <p class="text-xs text-emerald-500 mt-1" id="payPaidAmount">R0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all border-l-4 border-l-amber-500" onclick="filterPayments('unpaid')">
                    <p class="text-xs text-gray-400 font-medium mb-1">Unpaid</p>
                    <p class="text-3xl font-bold text-amber-600" id="payUnpaidCount">0</p>
                    <p class="text-xs text-amber-500 mt-1" id="payUnpaidAmount">R0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all border-l-4 border-l-red-500" onclick="filterPayments('overdue')">
                    <p class="text-xs text-gray-400 font-medium mb-1">Overdue</p>
                    <p class="text-3xl font-bold text-red-600" id="payOverdueCount">0</p>
                    <p class="text-xs text-red-500 mt-1" id="payOverdueAmount">R0</p>
                </div>
                <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all border-l-4 border-l-blue-500" onclick="filterPayments('partial')">
                    <p class="text-xs text-gray-400 font-medium mb-1">Partial</p>
                    <p class="text-3xl font-bold text-blue-600" id="payPartialCount">0</p>
                    <p class="text-xs text-blue-500 mt-1" id="payPartialAmount">R0</p>
                </div>
            </div>

            <!-- Aging Report -->
            <h3 class="text-xs font-semibold uppercase mb-3" style="color: var(--text-muted)">Aging Report</h3>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card p-4 text-center">
                    <p class="text-xs text-gray-400 font-medium mb-1">0-7 Days</p>
                    <p class="text-2xl font-bold text-green-600" id="aging7">0</p>
                    <p class="text-xs text-gray-400">Current</p>
                </div>
                <div class="card p-4 text-center">
                    <p class="text-xs text-gray-400 font-medium mb-1">8-14 Days</p>
                    <p class="text-2xl font-bold text-amber-500" id="aging14">0</p>
                    <p class="text-xs text-gray-400">Due Soon</p>
                </div>
                <div class="card p-4 text-center">
                    <p class="text-xs text-gray-400 font-medium mb-1">15-30 Days</p>
                    <p class="text-2xl font-bold text-orange-500" id="aging30">0</p>
                    <p class="text-xs text-gray-400">Overdue</p>
                </div>
                <div class="card p-4 text-center">
                    <p class="text-xs text-gray-400 font-medium mb-1">30+ Days</p>
                    <p class="text-2xl font-bold text-red-600" id="aging30plus">0</p>
                    <p class="text-xs text-gray-400">Critical</p>
                </div>
            </div>

            <!-- Filters & Search -->
            <div class="flex flex-wrap items-center gap-3 mb-6">
                <div class="relative flex-1 min-w-[200px] max-w-sm">
                    <input type="text" id="paymentSearchFilter" placeholder="Search client, order #, account..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500/20" oninput="filterPayments()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <select id="paymentStatusFilter" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500/20" onchange="filterPayments()">
                    <option value="">All Payment Status</option>
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                    <option value="overdue">Overdue</option>
                    <option value="partial">Partial</option>
                </select>
                <button onclick="sendBulkReminders()" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    Send Reminders
                </button>
                <span id="paymentFilterCount" class="text-sm text-gray-500 ml-auto"></span>
            </div>

            <!-- Payments Table -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-500 text-xs uppercase tracking-wider">
                                <th class="py-3 px-4 font-medium">Client</th>
                                <th class="py-3 px-4 font-medium">Order #</th>
                                <th class="py-3 px-4 font-medium">Package</th>
                                <th class="py-3 px-4 font-medium">Amount</th>
                                <th class="py-3 px-4 font-medium">Payment Status</th>
                                <th class="py-3 px-4 font-medium">Age</th>
                                <th class="py-3 px-4 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <tr class="table-row border-b">
                                <td class="py-4 px-4" colspan="7">
                                    <p class="text-gray-500 text-center">Loading payment data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payment Status Modal -->
        <div class="modal-overlay" id="paymentStatusModal">
            <div class="modal-container max-w-lg">
                <div class="modal-header">
                    <h3 class="font-bold text-gray-800">Update Payment Status</h3>
                    <button onclick="closeModal('paymentStatusModal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Client</p>
                        <p class="font-medium text-gray-800" id="payModalClient">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Order</p>
                        <p class="font-medium text-gray-800" id="payModalOrder">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                        <select id="payModalStatus" class="w-full border rounded-lg px-4 py-2">
                            <option value="unpaid">Unpaid</option>
                            <option value="paid">Paid</option>
                            <option value="partial">Partial Payment</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Amount (R)</label>
                        <input type="number" id="payModalAmount" class="w-full border rounded-lg px-4 py-2" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                        <select id="payModalMethod" class="w-full border rounded-lg px-4 py-2">
                            <option value="">Select method</option>
                            <option value="eft">EFT / Bank Transfer</option>
                            <option value="debit_order">Debit Order</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card Payment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
                        <input type="date" id="payModalDate" class="w-full border rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="payModalNotes" class="w-full border rounded-lg px-4 py-2" rows="2" placeholder="Payment reference, notes..."></textarea>
                    </div>
                    <button onclick="savePaymentStatus()" class="w-full btn-primary py-2.5 rounded-lg font-medium">
                        Save Payment Status
                    </button>
                </div>
            </div>
        </div>

        <!-- Agents Section -->
        <section id="section-agents" class="p-4 md:p-6 hidden">
            <div class="flex items-center justify-between mb-5">
                <p class="text-sm" style="color: var(--text-muted)">Manage your agent team</p>
                <button onclick="openModal('addAgentModal')" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Agent
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="agentsGrid">
                <div class="card p-6 text-center">
                    <p class="text-gray-500">Loading agents...</p>
                </div>
            </div>
        </section>

        <!-- Packages Section -->
        <section id="section-packages" class="p-4 md:p-6 hidden">
            <div class="flex items-center justify-between mb-5">
                <p class="text-sm" style="color: var(--text-muted)">Manage Openserve fibre packages</p>
                <button onclick="openModal('addPackageModal')" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Package
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="packagesGrid">
                <div class="card p-6 text-center">
                    <p class="text-gray-500">Loading packages...</p>
                </div>
            </div>
        </section>

        <!-- Shipping Section -->
        <section id="section-shipping" class="p-4 md:p-6 hidden">
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Free Router Deliveries</h3>
                <p class="text-gray-500 text-sm mt-1">Track and manage free router deliveries for non-WebConnect and non-prepaid packages</p>
            </div>

            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="font-semibold text-gray-700">Pending Deliveries</h4>
                        <p class="text-sm text-gray-500">Orders requiring free router delivery</p>
                    </div>
                    <button onclick="markAllDeliveriesRequested()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700">
                        Mark All as Requested
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">
                                    <input type="checkbox" id="selectAllDeliveries" onchange="toggleAllDeliveries(this)" class="rounded">
                                </th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Account Number</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Client Name</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Package</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Address</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Order Date</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shippingTable">
                            <tr>
                                <td colspan="7" class="py-8 text-center text-gray-500">Loading deliveries...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card p-6 mt-6">
                <h4 class="font-semibold text-gray-700 mb-4">Completed Deliveries</h4>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Account Number</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Client Name</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Package</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Requested Date</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Requested By</th>
                            </tr>
                        </thead>
                        <tbody id="completedShippingTable">
                            <tr>
                                <td colspan="5" class="py-8 text-center text-gray-500">No completed deliveries</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Preorders Section -->
        <section id="section-preorders" class="p-4 md:p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Preorders</h2>
                    <p class="text-gray-500 text-sm">Manage and track preorder leads</p>
                </div>
                <div class="flex gap-2">
                    <select id="preorderStatusFilter" onchange="filterPreorders()" class="border rounded-lg px-4 py-2 focus:outline-none">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="qualified">Qualified</option>
                        <option value="converted">Converted</option>
                    </select>
                    <button onclick="exportPreorders()" class="btn-primary text-white px-4 py-2 rounded-lg">
                        Export Preorders
                    </button>
                </div>
            </div>

            <div class="card p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Client</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Contact</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Package</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Agent</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Dealer</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Created</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="preordersTable">
                            <tr>
                                <td colspan="8" class="py-8 text-center text-gray-500">No preorders found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="section-reports" class="p-4 md:p-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Agent Performance</h3>
                    <canvas id="agentPerformanceChart" height="250"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Monthly Conversions</h3>
                    <canvas id="monthlyConversionsChart" height="250"></canvas>
                </div>
            </div>
        </section>

        <!-- Returned Items Section -->
        <section id="section-returned" class="p-4 md:p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Returned Items</h2>
                    <p class="text-gray-500 text-sm">Orders returned for follow-up or correction</p>
                </div>
                <div class="flex gap-2">
                    <select id="returnedStatusFilter" onchange="filterReturnedItems()" class="border rounded-lg px-4 py-2 focus:outline-none">
                        <option value="">All Status</option>
                        <option value="pending">Pending Review</option>
                        <option value="acknowledged">Acknowledged</option>
                        <option value="resolved">Resolved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button onclick="exportReturnedItems()" class="btn-primary text-white px-3 py-1.5 rounded-lg text-sm">Export</button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card p-4">
                    <p class="text-gray-500 text-sm">Total Returned</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalReturned">0</p>
                </div>
                <div class="card p-4">
                    <p class="text-gray-500 text-sm">Pending Review</p>
                    <p class="text-2xl font-bold text-yellow-600" id="pendingReturned">0</p>
                </div>
                <div class="card p-4">
                    <p class="text-gray-500 text-sm">Resolved</p>
                    <p class="text-2xl font-bold text-green-600" id="resolvedReturned">0</p>
                </div>
                <div class="card p-4">
                    <p class="text-gray-500 text-sm">Rejected</p>
                    <p class="text-2xl font-bold text-red-600" id="rejectedReturned">0</p>
                </div>
            </div>

            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Order</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Client</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Returned By</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Reason</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="returnedItemsTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Import Section -->
        <section id="section-import" class="p-4 md:p-6 hidden">
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Mass Import Leads</h3>
                <p class="text-gray-500 text-sm mb-6">Upload a CSV file to import multiple leads at once. Leads will be assigned to dealers and agents as specified.</p>

                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">CSV Format Requirements:</h4>
                    <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600 overflow-x-auto">
                        <p class="mb-2">Your CSV file should have the following columns:</p>
                        <code class="bg-gray-200 px-2 py-1 rounded text-xs whitespace-nowrap">LEAD ID, AGENT, DEALER, DEAL, SERVICE ID, ACCOUNT NUMBER, STATUS, REGION, PRIMARY CONTACT NAME, PRIMARY CONTACT NUMBER, PRIMARY CONTACT EMAIL, SECONDARY CONTACT NAME, SECONDARY CONTACT NUMBER, SECONDARY CONTACT SECONDARY, SECONDARY CONTACT EMAIL, ORDER NUMBER, ORDER STATUS, ORDER DATE, DATE CAPTURED, LAST UPDATED, CAPTURED BY, SECONDARY CONTACT</code>
                        <ul class="mt-3 space-y-1 text-gray-500 text-xs">
                            <li> <strong>LEAD ID</strong> - Unique identifier to avoid duplicates</li>
                            <li> <strong>AGENT</strong> - Agent name or email</li>
                            <li> <strong>DEALER</strong> - Dealer name</li>
                            <li> <strong>DEAL</strong> - Package/deal name</li>
                            <li> <strong>PRIMARY CONTACT NAME</strong> - Client's full name</li>
                            <li> <strong>PRIMARY CONTACT NUMBER</strong> - Client's phone</li>
                            <li> <strong>PRIMARY CONTACT EMAIL</strong> - Client's email</li>
                            <li> <strong>STATUS</strong> - Lead status (new, contacted, qualified, etc.)</li>
                            <li> <strong>REGION</strong> - Client's address/region</li>
                        </ul>
                    </div>
                </div>

                <div class="mb-6">
                    <a href="#" onclick="downloadTemplate()" class="text-emerald-600 hover:text-emerald-700 font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download CSV Template
                    </a>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropZone">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-600 mb-2">Drag and drop your CSV file here, or</p>
                    <label class="btn-primary text-white px-6 py-2 rounded-lg font-medium cursor-pointer inline-block">
                        Browse Files
                        <input type="file" accept=".csv" class="hidden" id="csvFileInput" onchange="handleFileSelect(event)">
                    </label>
                </div>

                <div id="importPreview" class="mt-6 hidden">
                    <h4 class="font-medium text-gray-700 mb-4">Preview (first 5 rows):</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="previewTable"></table>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button onclick="confirmImport()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                            Import <span id="importCount">0</span> Leads
                        </button>
                        <button onclick="cancelImport()" class="border px-6 py-2 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="importProgress" class="mt-6 hidden">
                    <div class="flex items-center gap-4">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-emerald-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <span id="progressText" class="text-sm text-gray-600">0%</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dealers Section -->
        <section id="section-dealers" class="p-4 md:p-6 hidden">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-5 gap-4">
                <p class="text-sm" style="color: var(--text-muted)">Manage dealer organizations</p>
                <button onclick="openModal('addDealerModal')" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Dealer
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="dealersGrid">
                <div class="card p-6 text-center">
                    <p class="text-gray-500">Loading dealers...</p>
                </div>
            </div>
        </section>

        <!-- Pending Agents Section -->
        <section id="section-pending-agents" class="p-4 md:p-6 hidden">
            <div class="flex items-center justify-between mb-5">
                <p class="text-sm" style="color: var(--text-muted)">Review, approve, or add new agents awaiting setup</p>
                <button onclick="openModal('addPendingAgentModal')" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Pending Agent
                </button>
            </div>
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-500 text-sm">
                                <th class="px-6 py-4 font-medium">Name</th>
                                <th class="px-6 py-4 font-medium">Email</th>
                                <th class="px-6 py-4 font-medium">Dealer</th>
                                <th class="px-6 py-4 font-medium">Date Added</th>
                                <th class="px-6 py-4 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingAgentsTable">
                            <tr class="border-t">
                                <td class="px-6 py-4" colspan="5">
                                    <p class="text-gray-500 text-center">No pending agents</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Axxess Sales Section (Full Integration from Project 4) -->
        <section id="section-axxess-sales" class="p-4 md:p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Axxess Sales Dashboard</h3>
                    <p class="text-gray-500 text-sm">Full sales management  add, track, import, export, commissions & reminders</p>
                </div>
                <button onclick="loadAxxessSalesData()" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
            </div>

            <!-- Agent Selector (super_admin sees dropdown, others see their name) -->
            <div id="axAgentSelector"></div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-5 border-l-4 border-blue-500">
                    <p class="text-3xl font-bold text-gray-800" id="axxessAgentCount">0</p>
                    <p class="text-gray-500 text-sm">Agents</p>
                </div>
                <div class="card p-5 border-l-4 border-emerald-500">
                    <p class="text-3xl font-bold text-gray-800" id="axxessTotalSales">0</p>
                    <p class="text-gray-500 text-sm">Total Sales</p>
                </div>
                <div class="card p-5 border-l-4 border-purple-500">
                    <p class="text-3xl font-bold text-gray-800" id="axxessMonthSales">0</p>
                    <p class="text-gray-500 text-sm">This Month</p>
                </div>
                <div class="card p-5 border-l-4 border-orange-500">
                    <p class="text-3xl font-bold text-gray-800" id="axxessTotalValue">R0</p>
                    <p class="text-gray-500 text-sm">Commissioned Value</p>
                </div>
            </div>

            <!-- Sub-Tabs -->
            <div class="flex flex-wrap gap-1 mb-6 bg-gray-100 rounded-lg p-1">
                <button data-ax-tab="ax-overview" class="ax-tab-btn active px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-overview')">Overview</button>
                <button data-ax-tab="ax-add-sale" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-add-sale')">Add Sale</button>
                <button data-ax-tab="ax-current-month" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-current-month')">Current Month</button>
                <button data-ax-tab="ax-sales-history" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-sales-history')">History</button>
                <button data-ax-tab="ax-commission" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-commission')">Commission</button>
                <button data-ax-tab="ax-mass-import" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-mass-import')">Import</button>
                <button data-ax-tab="ax-export" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-export')">Export</button>
                <button data-ax-tab="ax-reminders" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-reminders')">Reminders</button>
                <button data-ax-tab="ax-free-trials" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-free-trials')">Free Trials</button>
                <button data-ax-tab="ax-status-checks" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-status-checks')">Status Checks</button>
                <button data-ax-tab="ax-permissions" class="ax-tab-btn px-3 py-2 rounded-lg text-sm font-medium transition" onclick="axSwitchTab('ax-permissions')">Permissions</button>
            </div>

            <!-- Tab Content (rendered dynamically by axxess-sales.js) -->
            <div id="axTabContent">
                <div class="card p-6 text-center text-gray-500">Loading Axxess sales data...</div>
            </div>
        </section>

        <!-- Axxess Status Update Modal -->
        <div id="axStatusModal" class="modal-overlay">
            <div class="modal-container" style="max-width:480px">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold">Update Sale Status</h3>
                    <button onclick="closeModal('axStatusModal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="modal-body p-6 space-y-4">
                    <p class="text-sm text-gray-500" id="axModalSaleInfo">-</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">New Status</label>
                        <select id="axModalStatus" onchange="axModalUpdateReasons()" class="w-full border rounded-lg px-3 py-2">
                            <option value="Paid-Active">Paid-Active</option>
                            <option value="Pending">Pending</option>
                            <option value="Partial">Partial</option>
                            <option value="Failed">Failed</option>
                            <option value="Free Trial">Free Trial</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status Details</label>
                        <select id="axModalReason" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Select Details...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="axModalNotes" class="w-full border rounded-lg px-3 py-2" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer flex justify-end gap-3 p-4 border-t">
                    <button onclick="closeModal('axStatusModal')" class="border px-4 py-2 rounded-lg text-sm">Cancel</button>
                    <button onclick="axUpdateSaleStatus()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">Update Status</button>
                </div>
            </div>
        </div>

        <!-- Axxess Reminder Modal -->
        <div id="axReminderModal" class="modal-overlay">
            <div class="modal-container" style="max-width:520px">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold">Create Reminder</h3>
                    <button onclick="closeModal('axReminderModal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="modal-body p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                        <input type="text" id="axRemTitle" class="w-full border rounded-lg px-3 py-2" placeholder="Follow up with client...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="axRemDesc" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time *</label>
                            <input type="datetime-local" id="axRemDatetime" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <select id="axRemPriority" class="w-full border rounded-lg px-3 py-2">
                                <option value="low">Low</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                            <input type="text" id="axRemClient" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account #</label>
                            <input type="text" id="axRemAccount" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Service ID</label>
                            <input type="text" id="axRemService" class="w-full border rounded-lg px-3 py-2">
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex justify-end gap-3 p-4 border-t">
                    <button onclick="closeModal('axReminderModal')" class="border px-4 py-2 rounded-lg text-sm">Cancel</button>
                    <button onclick="axSaveReminder()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">Create Reminder</button>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <section id="section-settings" class="p-4 md:p-6 hidden">
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800">System Settings</h3>
                <p class="text-gray-500 text-sm">Configure system-wide settings and integrations</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Supabase Configuration -->
                <div class="card p-6">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">Supabase Configuration</h4>
                            <p class="text-sm text-gray-500">Database connection settings</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Supabase Project URL</label>
                            <input type="url" id="supabaseUrlSetting" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="https://your-project.supabase.co">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Supabase API Key (anon public)</label>
                            <textarea id="supabaseKeySetting" rows="2" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-xs" placeholder="Enter your anon key"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveSupabaseConfig()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">Save Configuration</button>
                            <button onclick="testSupabaseConnection()" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50">Test Connection</button>
                        </div>
                        <div id="supabaseConfigStatus" class="p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                            <strong>Status:</strong> <span id="supabaseStatusText">Checking...</span>
                        </div>
                    </div>
                </div>

                <!-- Openserve API Integration -->
                <div class="card p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h4 class="font-semibold text-gray-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Openserve API Integration
                            </h4>
                            <p class="text-sm text-gray-500 mt-1">Connect to Openserve for live fibre availability data</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="openserveApiToggle" class="sr-only peer" onchange="toggleOpenserveApi(this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                        </label>
                    </div>
                    <div id="openserveApiConfig" class="hidden space-y-4 pt-4 border-t">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">API URL</label>
                            <input type="url" id="openserveApiUrl" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="https://api.openserve.co.za">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="password" id="openserveApiKey" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Enter your API key">
                        </div>
                        <button onclick="saveOpenserveConfig()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">Save Configuration</button>
                    </div>
                    <div class="mt-4 p-3 bg-amber-50 rounded-lg text-sm text-amber-700" id="openserveApiStatus">
                        <strong>Status:</strong> Inactive - Enable to connect to live Openserve data
                    </div>
                </div>

                <!-- General Settings -->
                <div class="card p-6">
                    <h4 class="font-semibold text-gray-800 mb-4">General Settings</h4>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between py-3 border-b">
                            <div>
                                <p class="font-medium text-gray-700">Auto-approve agents</p>
                                <p class="text-sm text-gray-500">Skip approval for new agents from CSV</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoApproveAgents" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between py-3 border-b">
                            <div>
                                <p class="font-medium text-gray-700">Email notifications</p>
                                <p class="text-sm text-gray-500">Get notified for new leads and orders</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="emailNotifications" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between py-3 border-b">
                            <div>
                                <p class="font-medium text-gray-700">Auto-confirm commissions</p>
                                <p class="text-sm text-gray-500">Auto-confirm after 30 days</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoConfirmCommissions" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Privileges Management -->
            <div class="mt-6">
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h4 class="font-semibold text-gray-800">User Privileges Management</h4>
                            <p class="text-sm text-gray-500">Assign roles and permissions to users</p>
                        </div>
                        <button onclick="openModal('addPrivilegeModal')" class="btn-primary text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add User
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">User</th>
                                    <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Privileges</th>
                                    <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="privilegesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <div class="card p-6">
                    <h4 class="font-semibold text-gray-800 mb-4">Data Export</h4>
                    <p class="text-sm text-gray-500 mb-4">Export your data for backup or analysis</p>
                    <div class="space-y-3">
                        <button onclick="exportData('leads')" class="w-full flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <span class="font-medium text-gray-700">Export All Leads</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button onclick="exportData('agents')" class="w-full flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <span class="font-medium text-gray-700">Export All Agents</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button onclick="exportData('dealers')" class="w-full flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <span class="font-medium text-gray-700">Export All Dealers</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button onclick="exportData('all')" class="w-full flex items-center justify-between p-3 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100">
                            <span class="font-medium text-emerald-700">Export Complete Backup</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <h4 class="font-semibold text-gray-800 mb-4">Danger Zone</h4>
                    <p class="text-sm text-gray-500 mb-4">Irreversible and destructive actions</p>
                    <div class="space-y-3">
                        <button onclick="confirmResetStats()" class="w-full flex items-center justify-between p-3 border border-orange-200 bg-orange-50 rounded-lg hover:bg-orange-100">
                            <span class="font-medium text-orange-700">Reset Dashboard Statistics</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                        <button onclick="confirmClearNotifications()" class="w-full flex items-center justify-between p-3 border border-orange-200 bg-orange-50 rounded-lg hover:bg-orange-100">
                            <span class="font-medium text-orange-700">Clear All Notifications</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Add New Lead</h3>
                <button onclick="closeModal('addLeadModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="addLeadForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                        <input type="text" name="first_name" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                        <input type="text" name="last_name" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" name="email" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input type="tel" name="phone" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ID Number</label>
                        <input type="text" name="id_number" id="newLeadIdNumber" maxlength="13" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="13-digit SA ID">
                        <p id="newLeadIdError" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Passport Number</label>
                        <input type="text" name="passport_number" id="newLeadPassport" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Passport Number">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                        <input type="text" name="address" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Package Interest</label>
                        <select name="package_id" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" id="leadPackageSelect">
                            <option value="">Select Package</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Agent</label>
                        <select name="agent_id" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" id="leadAgentSelect">
                            <option value="">Select Agent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea name="notes" rows="3" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('addLeadModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Add Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Openserve Email Import Modal -->
    <div id="openserveEmailModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--success)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold">Import from Openserve Email</h3>
                        <p class="text-sm text-gray-500">Paste the Openserve lead notification email to create a lead</p>
                    </div>
                </div>
                <button onclick="closeModal('openserveEmailModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <!-- Step 1: Paste Email -->
                <div id="osEmailStep1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paste the Openserve email content below:</label>
                    <textarea id="openserveEmailText" rows="10" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500/20 text-sm font-mono" placeholder="Heads up, AXXESS AFRICA!

Dear valued partner

The below customer has expressed interest in purchasing your Fibre services, please contact them for further processing.

Lead ID: L10397
Dealer code: ODUN

Customer details:

Full names: Nonopha Vukaphi
Email address: example@gmail.com
Primary contact number: 0788260588
..."></textarea>
                    <div class="flex items-center gap-3 mt-4">
                        <button onclick="parseOpenserveEmail()" class="btn-success text-white px-5 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Parse Email
                        </button>
                        <button onclick="pasteFromClipboard()" class="border border-gray-300 text-gray-700 px-5 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Paste from Clipboard
                        </button>
                    </div>
                </div>

                <!-- Step 2: Review Parsed Data -->
                <div id="osEmailStep2" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-green-700 font-medium mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Email parsed successfully!
                        </div>
                        <p class="text-sm text-green-600">Review the extracted details below, then click Save to create the lead.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lead ID</label>
                            <input type="text" id="osLeadId" readonly class="w-full border rounded-lg px-4 py-2 bg-gray-50 text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dealer Code</label>
                            <input type="text" id="osDealerCode" readonly class="w-full border rounded-lg px-4 py-2 bg-gray-50 text-gray-600">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="osFullName" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="osEmail" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Primary Contact</label>
                            <input type="tel" id="osPrimaryPhone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alternative Contact</label>
                            <input type="tel" id="osAltPhone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Time</label>
                            <input type="text" id="osContactTime" readonly class="w-full border rounded-lg px-4 py-2 bg-gray-50 text-gray-600">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Physical Address</label>
                        <input type="text" id="osAddress" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                    </div>
                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Building</label>
                            <input type="text" id="osBuilding" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                            <input type="text" id="osFloor" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                            <input type="text" id="osUnit" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Dealer</label>
                            <select id="osDealerSelect" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                                <option value="">Auto-match by dealer code</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Agent</label>
                            <select id="osAgentSelect" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500/20">
                                <option value="">Select Agent (optional)</option>
                            </select>
                        </div>
                    </div>

                    <div id="osDealerMatch" class="mt-3 hidden"></div>

                    <div class="flex items-center justify-between mt-6 pt-4 border-t">
                        <button onclick="resetOpenserveEmail()" class="px-5 py-2 border rounded-lg hover:bg-gray-50 text-gray-600 font-medium">
                            Back
                        </button>
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="closeModal('openserveEmailModal')" class="px-5 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                            <button onclick="saveOpenserveLead()" class="btn-success text-white px-5 py-2 rounded-lg font-medium transition flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Save Lead
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Agent Modal -->
    <div id="addAgentModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Add New Agent</h3>
                <button onclick="closeModal('addAgentModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="addAgentForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="full_name" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" name="email" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <input type="password" name="password" required minlength="6" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" name="phone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('addAgentModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Create Agent</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div id="editAgentModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Edit Agent</h3>
                <button onclick="closeModal('editAgentModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="editAgentForm" class="p-6 space-y-4">
                <input type="hidden" name="agent_id" id="editAgentId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="full_name" id="editAgentName" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" id="editAgentEmail" readonly class="w-full border rounded-lg px-4 py-2 bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" name="phone" id="editAgentPhone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Dealer</label>
                    <select name="dealer_id" id="editAgentDealer" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                        <option value="">No dealer assigned</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select name="is_approved" id="editAgentApproved" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                        <option value="true">Approved</option>
                        <option value="false">Pending</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('editAgentModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Dealer Modal -->
    <div id="editDealerModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-lg m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Edit Dealer</h3>
                <button onclick="closeModal('editDealerModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="editDealerForm" class="p-6 space-y-4">
                <input type="hidden" name="dealer_id" id="editDealerId">
                <div class="flex items-center gap-4 mb-4">
                    <div id="dealerLogoPreview" class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 overflow-hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Logo URL</label>
                        <input type="url" name="logo_url" id="editDealerLogo" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="https://example.com/logo.png" oninput="previewDealerLogo(this.value)">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dealer Name *</label>
                    <input type="text" name="name" id="editDealerName" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dealer Code</label>
                        <input type="text" name="code" id="editDealerCode" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="is_active" id="editDealerActive" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                        <input type="email" name="contact_email" id="editDealerEmail" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
                        <input type="tel" name="contact_phone" id="editDealerPhone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assigned Agents</label>
                    <div id="dealerAgentsList" class="bg-gray-50 rounded-lg p-3 max-h-32 overflow-y-auto text-sm text-gray-600">
                        Loading agents...
                    </div>
                </div>
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-medium text-gray-800 mb-3">Dealer Portal Login</h4>
                    <p class="text-xs text-gray-500 mb-3">Set login credentials for the dealer to access the Dealer Portal</p>
                    <div id="dealerLoginStatus" class="mb-3 text-sm"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Login Email *</label>
                            <input type="email" name="login_email" id="editDealerLoginEmail" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="dealer@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" name="login_password" id="editDealerLoginPassword" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Leave blank to keep existing">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('editDealerModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div id="addPackageModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Add New Package</h3>
                <button onclick="closeModal('addPackageModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="addPackageForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Package Name *</label>
                    <input type="text" name="name" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="e.g., Fibre 50Mbps">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Speed (Mbps) *</label>
                    <input type="number" name="speed" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Price (R) *</label>
                    <input type="number" name="price" required step="0.01" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="699.00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="3" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('addPackageModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Add Package</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Package Modal -->
    <div id="editPackageModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Edit Package</h3>
                <button onclick="closeModal('editPackageModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="editPackageForm" class="p-6 space-y-4">
                <input type="hidden" id="editPackageId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Package Name *</label>
                    <input type="text" id="editPackageName" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Speed (Mbps) *</label>
                    <input type="number" id="editPackageSpeed" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Price (R) *</label>
                    <input type="number" id="editPackagePrice" required step="0.01" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Cap</label>
                    <input type="text" id="editPackageDataCap" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Uncapped">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Commission (R)</label>
                    <input type="number" id="editPackageCommission" step="0.01" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="200">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="editPackageDescription" rows="3" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('editPackageModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Return to Agent Modal -->
    <div id="returnToAgentModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Return to Agent</h3>
                <button onclick="closeModal('returnToAgentModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="returnToAgentForm" class="p-6 space-y-4">
                <input type="hidden" name="item_id" id="returnItemId">
                <input type="hidden" name="item_type" id="returnItemType">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Return *</label>
                    <textarea name="return_reason" required rows="3" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Please provide a reason..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('returnToAgentModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Return</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Dealer Modal -->
    <div id="addDealerModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Add New Dealer</h3>
                <button onclick="closeModal('addDealerModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="addDealerForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dealer Name *</label>
                    <input type="text" name="name" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dealer Code</label>
                    <input type="text" name="code" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="e.g., MTL">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                    <input type="email" name="contact_email" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
                    <input type="tel" name="contact_phone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('addDealerModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Add Dealer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Approve Agent Modal -->
    <div id="approveAgentModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Approve Agent</h3>
                <button onclick="closeModal('approveAgentModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="approveAgentForm" class="p-6 space-y-4">
                <input type="hidden" name="pending_agent_id" id="pendingAgentId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="full_name" id="approveAgentName" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" name="email" id="approveAgentEmail" required readonly class="w-full border rounded-lg px-4 py-2 bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <input type="password" name="password" required minlength="6" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Set password for agent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" name="phone" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Dealer</label>
                    <select name="dealer_id" id="approveAgentDealer" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                        <option value="">No dealer</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('approveAgentModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Approve & Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Pending Agent Modal -->
    <div id="addPendingAgentModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-semibold">Add Pending Agent</h3>
                <button onclick="closeModal('addPendingAgentModal')" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="addPendingAgentForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="full_name" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Agent full name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" name="email" required class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="agent@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Dealer</label>
                    <select name="dealer_id" id="addPendingAgentDealer" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                        <option value="">No dealer (internal agent)</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('addPendingAgentModal')" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Add to Pending</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Lead Details Modal -->
    <div id="viewLeadModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b flex items-center justify-between sticky top-0 bg-white z-10" style="border-color: var(--card-border)">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center" style="background: var(--purple-light)">
                        <svg class="w-5 h-5" style="color: var(--purple)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold" style="color: var(--text-primary)">Lead Details</h3>
                        <p class="text-xs" style="color: var(--text-muted)">View and edit lead information</p>
                    </div>
                </div>
                <button onclick="closeModal('viewLeadModal')" class="p-1.5 rounded-lg hover:bg-gray-100 transition" style="color: var(--text-muted)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-5" id="viewLeadContent">
                <p class="text-gray-500 text-center">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Convert to Order Modal -->
    <div id="convertToOrderModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-md m-4">
            <div class="p-5 border-b flex items-center justify-between" style="border-color: var(--card-border)">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center" style="background: var(--success-light)">
                        <svg class="w-5 h-5" style="color: var(--success)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold" style="color: var(--text-primary)">Convert Lead to Order</h3>
                        <p class="text-xs" style="color: var(--text-muted)">Create an order from this lead</p>
                    </div>
                </div>
                <button onclick="closeModal('convertToOrderModal')" class="p-1.5 rounded-lg hover:bg-gray-100 transition" style="color: var(--text-muted)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="border rounded-lg p-3 flex items-center gap-2" style="border-color: var(--info); background: var(--info-light)">
                    <svg class="w-4 h-4 flex-shrink-0" style="color: var(--info)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <p class="text-sm" style="color: #1e40af">Converting: <strong id="convertLeadName">-</strong></p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Order Number *</label>
                    <input type="text" id="convertOrderNumber" required class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition" placeholder="e.g. ORD-12345">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Product Type *</label>
                    <select id="convertProductType" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                        <option value="postpaid">Postpaid (R200 commission)</option>
                        <option value="prepaid">Prepaid (R100 commission)</option>
                    </select>
                </div>
                <div class="border rounded-lg p-3" style="border-color: var(--card-border)">
                    <p class="text-xs font-medium text-gray-600">Commission will be calculated based on product type:</p>
                    <ul class="text-xs text-gray-500 mt-2 space-y-1">
                        <li class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full" style="background: var(--success)"></span> <strong>Postpaid:</strong> R200 per active service</li>
                        <li class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full" style="background: var(--info)"></span> <strong>Prepaid:</strong> R100 per active service</li>
                    </ul>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t" style="border-color: var(--card-border)">
                    <button type="button" onclick="closeModal('convertToOrderModal')" class="px-5 py-2 border rounded-lg hover:bg-gray-50 text-sm">Cancel</button>
                    <button onclick="convertToOrder()" class="btn-success text-white px-5 py-2 rounded-lg font-medium text-sm">Convert to Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Order Modal -->
    <div id="viewOrderModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b flex items-center justify-between sticky top-0 bg-white z-10" style="border-color: var(--card-border)">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center" style="background: var(--info-light)">
                        <svg class="w-5 h-5" style="color: var(--info)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold" style="color: var(--text-primary)">Order Details</h3>
                        <p class="text-xs" style="color: var(--text-muted)">View and edit order information</p>
                    </div>
                </div>
                <button onclick="closeModal('viewOrderModal')" class="p-1.5 rounded-lg hover:bg-gray-100 transition" style="color: var(--text-muted)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="editOrderForm" class="p-5 space-y-5">
                <input type="hidden" id="editOrderLeadId">

                <!-- Order Status -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Order Number</label>
                        <input type="text" id="editOrderNumber" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Order Status</label>
                        <select id="editOrderStatus" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <!-- Order Reference -->
                <div class="border rounded-lg p-4" style="border-color: var(--card-border)">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" style="color: var(--info)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                        Order Reference
                    </h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Service ID</label>
                            <input type="text" id="editOrderServiceId" class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Account Number</label>
                            <input type="text" id="editOrderAccountNumber" class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Lead ID</label>
                            <input type="text" id="editOrderLeadIdDisplay" class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50" readonly>
                        </div>
                    </div>
                </div>

                <!-- Client Information -->
                <div class="border rounded-lg p-4" style="border-color: var(--card-border)">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" style="color: var(--success)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Client Information
                    </h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Full Name</label>
                            <input type="text" id="editOrderClientName" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ID Number</label>
                            <input type="text" id="editOrderIdNumber" maxlength="13" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition" placeholder="13-digit SA ID">
                            <p id="editOrderIdError" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Passport Number</label>
                            <input type="text" id="editOrderPassport" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition" placeholder="Passport">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Email</label>
                            <input type="email" id="editOrderEmail" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Phone</label>
                            <input type="tel" id="editOrderPhone" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Address</label>
                            <input type="text" id="editOrderAddress" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                        </div>
                    </div>
                </div>

                <!-- Assignment -->
                <div class="border rounded-lg p-4" style="border-color: var(--card-border)">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" style="color: var(--orange)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        Assignment
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Agent</label>
                            <select id="editOrderAgent" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Dealer</label>
                            <select id="editOrderDealer" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Commission -->
                <div class="border rounded-lg p-4" style="border-color: var(--card-border)">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" style="color: var(--cyan)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Commission
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Commission Amount</label>
                            <input type="number" id="editOrderCommission" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Commission Status</label>
                            <select id="editOrderCommissionStatus" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition">
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="border rounded-lg p-4" style="border-color: var(--warning); border-left-width: 3px;">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" style="color: var(--warning)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Notes
                    </h4>
                    <textarea id="editOrderNotes" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition"></textarea>
                </div>

                <!-- Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t" style="border-color: var(--card-border)">
                    <button type="button" onclick="closeModal('viewOrderModal')" class="px-5 py-2 border rounded-lg hover:bg-gray-50 text-sm">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-5 py-2 rounded-lg font-medium text-sm">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin-dashboard.js"></script>
    <script>document.write('<script src="js/axxess-sales.js?v=' + Date.now() + '"><\/script>');</script>
    <script src="js/admin-dashboard-stats.js"></script>
    <script src="js/preorders.js"></script>
    
    <!-- Debug: Fix Missing Orders -->
    <script>
        async function fixMissingOrders() {
            if (!confirm('This will create order records for converted leads that are missing orders. Continue?')) {
                return;
            }
            
            console.log('Finding converted leads without orders...');
            
            // Get all converted leads
            const { data: leads, error: leadsError } = await window.supabaseClient
                .from('leads')
                .select('*')
                .eq('status', 'converted')
                .order('updated_at', { ascending: false });
            
            if (leadsError) {
                console.error('Error loading leads:', leadsError);
                alert('Error loading leads: ' + leadsError.message);
                return;
            }
            
            console.log(`Found ${leads.length} converted leads`);
            const missingOrders = [];
            
            // Check each lead for corresponding order
            for (const lead of leads) {
                const { data: orders } = await window.supabaseClient
                    .from('orders')
                    .select('id')
                    .eq('lead_id', lead.id);
                
                if (!orders || orders.length === 0) {
                    missingOrders.push(lead);
                }
            }
            
            console.log(`Found ${missingOrders.length} leads without orders`);
            
            if (missingOrders.length === 0) {
                alert('No missing orders found! All converted leads have orders.');
                return;
            }
            
            // Create missing orders
            let created = 0;
            let failed = 0;
            
            for (const lead of missingOrders) {
                try {
                    console.log(`Creating order for ${lead.full_name || lead.first_name + ' ' + lead.last_name}...`);
                    
                    const { error: insertError } = await window.supabaseClient
                        .from('orders')
                        .insert({
                            lead_id: lead.id,
                            package_id: lead.package_id,
                            agent_id: lead.agent_id,
                            dealer_id: lead.dealer_id,
                            order_number: lead.order_number || `ORD-${Date.now()}`,
                            status: lead.order_status || 'pending',
                            notes: `Recovered order - Commission: R${lead.commission_amount || 200}\nService ID: ${lead.service_id || 'N/A'}\nAccount: ${lead.account_number || 'N/A'}\nLead ID: ${lead.lead_id || 'N/A'}\nID Number: ${lead.id_number || 'N/A'}`
                        });
                    
                    if (insertError) {
                        console.error(`Failed to create order:`, insertError);
                        failed++;
                    } else {
                        console.log(` Created order for ${lead.order_number}`);
                        created++;
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    failed++;
                }
            }
            
            alert(`Orders Recovery Complete!\n\n Created: ${created}\n Failed: ${failed}\n\nRefresh the page to see the orders.`);
            
            if (created > 0) {
                await loadOrders();
                showSection('orders');
            }
        }
        
        // Add to window for console access
        window.fixMissingOrders = fixMissingOrders;
        
        // Function to update existing orders with missing dealer and lead data
        async function updateIncompleteOrders() {
            if (!confirm('This will update existing orders to include dealer assignments and lead data. Continue?')) {
                return;
            }
            
            console.log('Finding orders with missing dealer or lead data...');
            
            // Get all orders
            const { data: allOrders, error: ordersError } = await window.supabaseClient
                .from('orders')
                .select(`
                    *,
                    lead:leads(*)
                `)
                .order('created_at', { ascending: false });
            
            if (ordersError) {
                console.error('Error loading orders:', ordersError);
                alert('Error loading orders: ' + ordersError.message);
                return;
            }
            
            console.log(`Found ${allOrders.length} total orders`);
            
            // Find orders that need updating (missing dealer or incomplete notes)
            const ordersToUpdate = allOrders.filter(order => {
                const hasLead = order.lead;
                const missingDealer = !order.dealer_id && hasLead && hasLead.dealer_id;
                const incompleteNotes = order.notes && !order.notes.includes('Service ID:');
                return hasLead && (missingDealer || incompleteNotes);
            });
            
            console.log(`Found ${ordersToUpdate.length} orders to update`);
            
            if (ordersToUpdate.length === 0) {
                alert('No incomplete orders found! All orders have complete data.');
                return;
            }
            
            // Update orders
            let updated = 0;
            let failed = 0;
            
            for (const order of ordersToUpdate) {
                try {
                    const lead = order.lead;
                    console.log(`Updating order ${order.order_number}...`);
                    
                    // Clean up notes - remove lead details since they're now in proper fields
                    const baseNotes = order.notes || '';
                    const commissionMatch = baseNotes.match(/Commission: R(\d+)/);
                    const commission = commissionMatch ? commissionMatch[1] : (lead.commission_amount || 200);
                    
                    // Keep only the first line (product type and commission)
                    const cleanNotes = baseNotes.split('\n')[0] || `Order - Commission: R${commission}`;
                    
                    const { error: updateError } = await window.supabaseClient
                        .from('orders')
                        .update({
                            dealer_id: lead.dealer_id || order.dealer_id,
                            notes: cleanNotes
                        })
                        .eq('id', order.id);
                    
                    if (updateError) {
                        console.error(`Failed to update order:`, updateError);
                        failed++;
                    } else {
                        console.log(` Updated order ${order.order_number}`);
                        updated++;
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    failed++;
                }
            }
            
            alert(`Orders Update Complete!\n\n Updated: ${updated}\n Failed: ${failed}\n\nRefresh the page to see the changes.`);
            
            if (updated > 0) {
                await loadOrders();
                showSection('orders');
            }
        }
        
        window.updateIncompleteOrders = updateIncompleteOrders;
        console.log(' To fix missing orders, run: fixMissingOrders()');
        console.log(' To update incomplete orders, run: updateIncompleteOrders()');
    </script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        // Close sidebar when clicking a nav item on mobile
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth < 769) {
                    toggleSidebar();
                }
            });
        });
    </script>
</body>
</html>
